<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <title>localizator@notes</title>
    <meta name="description" content="">
    <meta name="author" content="localizator">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://localizator.github.io/theme/html5.js"></script>
    <![endif]-->
    
    <link rel="shortcut icon" href="/favicon.ico" title="Favicon" />

    <!-- Le styles -->
    <link href="http://localizator.github.io/theme/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://localizator.github.io/theme/css/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://localizator.github.io/theme/css/local.css" rel="stylesheet">
    <link rel="stylesheet" href="http://localizator.github.io/theme/css/pygment-solarized-dark.css"/>

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://localizator.github.io">localizator@notes</a>

        <div class="nav-collapse">
        <ul class="nav">
            <li><a href="/">Головна</a></li>
            <li><a href="/category/news/">Новини</a></li>
            <li><a href="/category/apps/">Програми</a></li>
            <li><a href="/category/howto/">ЯКЦЕ</a></li>
            
            <li><a href="http://localizator.github.io/about/">Про блог</a></li>
            <li><a href="http://localizator.github.io/rom/">ROM</a></li>
            <li><a href="http://localizator.github.io/services/">Послуги</a></li>
        </ul>

         <form class="navbar-search pull-right" method="get" target="_blank" action="http://www.google.com/search">
                    <div class="input-append">
                        <input class="input-search" id="appendedInputButton" type="text" name="q">
                        <button class="btn" type="submit"><i class="icon-search"></i></button>
                    </div>
                    <input type="hidden" name="sitesearch" value="localizator.github.com">
                </form>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="http://localizator.github.io/2013-08-27/yandex-disk-official-released-linux/"><h1>Вийшов офіційний клієнт Яндекс.Диск для Linux</h1></a>
<span class="article-date">27 серпня 2013</span>&nbsp;<span class="article-section">у розділі <a href="http://localizator.github.io/category/linux/">linux</a></span>&nbsp; 
 <span class="article-tag">з тегами: <a href="http://localizator.github.io/tag/yandex/">yandex</a>, <a href="http://localizator.github.io/tag/disk/">disk</a></span> 
        </div>
        
        <div><p>Яндекс.Диск - хмарний сервіс компанії Яндекс. Раніше з Linux працював тільки через WebDAV, для чого були придатні лише деякі файлові менеджери, або монтування за допомогою davfs2.</p>
<p>Тепер випущений клієнт. Консольний, вихідні коди закриті - але настроювати зручніше, ніж davfs2, а синхронізація локальних файлів не вимагає скриптової обв'язки. Досить встановити програму, налаштувати підключення, а потім вибрати каталоги, які підлягають або не підлягають синхронізації.
<!-- more -->
У нього є вся основна функціональність, яка є у клієнтів для OS X і Windows, і навіть більше (сімлінки!), і одна особливість - він консольний.</p>
<p><img alt="Яндекс.Диск" src="/images/2013/09/yandex_disk.png" />  </p>
<p>Нижче читайте про те, як він налаштовується, що конкретно вміє, і про те, як саме він влаштований і що в ньому було непросто зробити.</p>
<p><strong>Встановлення</strong></p>
<p>Встановити його можна <a href="http://repo.yandex.ru/yandex-disk/">тут</a>. Відразу після установки пакета в терміналі з'явиться команда <strong>yandex-disk</strong>, через яку в подальшому і йде робота з хмарою Яндекса. Після цього потрібно вручну запустити команду <strong>setup</strong>.</p>
<p>Майстер налаштування дозволяє в режимі діалогу вибрати папку для синхронізації, включити автозапуск при старті системи, налаштувати роботу через проксі-сервер (якщо звичайно ви ним користуєтеся) і авторизуватися в Яндекс.Диск. При налаштуванні вручну насамперед необхідно авторизуватися. Після цього в папці .config, розташованої в домашньому каталозі, буде створений конфіг, в якому можна буде налаштувати шлях до папки синхронізації (можна вказати в консолі вручну), прописати шлях до файлу токену, вказати папки, які будуть чи не будуть синхронізуватися, і прописати налаштування проксі-сервера.</p>
<p><strong>Команди</strong></p>
<p>Підготовча робота закінчена, залишилося запустити демон однієї з команд. Вони дозволять вам синхронізувати файли і папки і користуватися ними скрізь, де є інтернет .</p>
<ul>
<li><strong>sync</strong> - запустить демон, синхронізує все, що знаходиться в папці Диска, і зупинить демон.</li>
<li><strong>start</strong> - зробить те ж саме, але без зупинки демона після завершення синхронізації. При використанні start демон залишається запущений і всі зміни, що відбуваються в папці Диска , будуть синхронізуватися автоматично.</li>
<li>Ввівши в терміналі <strong>stop</strong>, можна в будь-який момент зупинити запущений демон, якщо він вам заважає.</li>
<li>Командою <strong>status</strong> можна дізнатися , в якому статусі знаходиться ядро ​​синхронізації.</li>
</ul>
<p>Працювати з папкою диска можна як з терміналу, так і з Nautilus'a.</p>
<p><strong>Що вміє</strong></p>
<p>Консольний клієнт дозволяє поділитися файлом або текою за допомогою команди <strong>publish</strong> (якщо файл знаходиться не в папці диска, перед публікацією він буде туди скопійований). Посилання буде доступна в терміналі, і будь-яка людина, перейшовши по ньому, зможе подивитися або зберегти собі опублікований вами файл або теку. Якщо випадково був опублікований не той файл, за допомогою команди <strong>unpublish</strong> можна закрити доступ до публічного об'єкту.</p>
<p>У Яндекс.Диск можлива вибіркова синхронізація. Команда <strong>exclude</strong> дозволить виключити папку з синхронізації: всі зміни, зроблені в ній після цього, не будуть відправлені в хмару.</p>
<p>Опція <strong>read-only</strong> дозволить міняти файли локально, без заливки їх в хмару. При виникненні конфліктів з локальними змінами, останні будуть збережені в перейменованих файлах, а зміни з хмари будуть синхронізовані. Опція <strong>overwrite</strong> буде перезаписувати локально змінені файли в режимі read-only .</p>
<p>Не можемо не похвалитися самим цікавим нововведенням в ядрі синхронізації - відтепер ми підтримуємо синхронізацію символічних посиланнь (symlink)! Якщо виникнуть труднощі і питання у використанні консольного клієнта команди man і help просто і доступно допоможуть у них розібратися.</p>
<p><strong>Як зроблено</strong></p>
<p>Щоб у майбутньому код можна було використовувати для реалізації клієнтів під різні ОС, було прийнято рішення писати його на C++. Специфічні для різних операційних систем шматки коду ми винесли в окремі функції чи класи, а під кожну платформу писали свою реалізацію. В якості основних кроссплатформенних бібліотек ми взяли Boost, OpenSSL і JsonCpp, а системою контролю версій став git. Клієнт під Linux збирався за допомогою autoconf. Код писався і налагоджувався у зв'язці KDevelop + консольний gdb  або в Qt Creator'е (залежно від уподобань розробника) .</p>
<p>Взаємодія з хмарою і синхронізація відбувається за допомогою бібліотеки ядра Яндекс.Диск , яку використовують десктопні клієнти сервісу.</p>
<p><strong>Як працює</strong></p>
<p>Консольний клієнт складається з двох частин: демона і клієнта. Спілкуються вони за допомогою текстових пакетів містять json - повідомлення, що посилаються через сокети (на Linux і Mac OS X використовуються unix - domain сокети). Асинхронна робота реалізована за допомогою бібліотеки boost::asio. Синхронізація доступу до даних реалізується через boost::asio::io_service::strand, що дозволяє не думати про проблему одночасного доступу до даних декількох потоків, а також виключає появу deadlock-ів.</p>
<p>Для локалізації ми використовуємо бібліотеку boost::locale. Текст всередині клієнта закодований в utf 8 і за необхідності перетворюється в специфічному для кожної операційної системи коді. Моніторинг файлової системи для Linux використовує inotify, чудово вписуються в асинхронну роботу boost::asio.</p>
<p><strong>Як влаштована синхронізація</strong></p>
<p>Синхронізація - серце Яндекс.Диск, його ключова можливість. Завдання синхронізації файлового дерева з хмарою ділиться на кілька незалежних частин.</p>
<p><strong>1.</strong> Моніторинг файлової системи. Ядро синхронізації Яндекс.Диск проектувалося і створювалося як переносима абстракція, здатна виконувати поставлені завдання на всіх підтримуваних платформах. Але така проблема, як моніторинг файлової системи не реалізується ні стандартної бібліотекою C++, ні навіть такими монстрами як boost. Більше того, навіть використовуючи «рідне» API операційної системи, ми отримуємо набір подій, специфічний для кожної платформи.</p>
<p>Для моніторингу файлової системи був спроектований інтерфейс «спостерігача» , здатного стежити за подіями в певній директорії і повертає список подій, що відбулися в ній. Причому для кожної підтримуваної платформи набір цих подій відрізняється. Наприклад, Mac OS X здатна повідомити тільки про факт якогось зміни в одній з дочірніх директоріях без деталізації. А ось Windows і Linux повертають повний набір, включаючи створення, видалення, модифікацію і переміщення об'єктів. Хоча практика показувала, що подіям на платформі Windows довіряти не варто і самим надійним варіантом залишається лістинг директорії після отримання оповіщення.</p>
<p><strong>2.</strong> Індексація локальних файлів і директорій. Для контролю цілісності та реалізації дельта -оновлення файлів ядро синхронізації Яндекс.Диск використовує дайджести - набори контрольних сум файлу і окремих його частин. Для всього файлу ми розраховуємо стійкий хеш SHA-256 і набір менш стійких сум для окремих блоків. Кожен файл, що знаходиться в папці Яндекс.Диск і не потрапляє до списку винятків, повинен бути проіндексований. Але обчислення хеша SHA-256 досить дорога операція, а розрахунок хешей при кожному запуску ПО був б великою витратою ресурсів. Тому після того, як завершується індексація файлу , ядро синхронізації зберігає отриманий дайджест в «банці» - спеціальному сховищі, що знаходиться у службовій директорії Яндекс.Диск. Для пошуку дайджестів в сховище використовується унікальний ідентифікатор файлу - inode (розмір і час останньої зміни) . На жаль, подібний підхід не позбавлений недоліків. Наприклад, багато файлів - криптоконтейнера зберігають час останньої модифікації незмінним навіть після запису .</p>
<p>Напевно, крім тонкощів роботи з символічними посиланнями , нічого в лістингу директорій не представляє особливого інтересу. Для успішного завершення синхронізації ядро повинне виявляти і виключати з синхронізації циклічні гілки .</p>
<p>Взагалі , символічні посилання - це справжня «головна біль» для ядра синхронізації. Вони можуть вказувати у довільні місця файлової системи , і ні до всіх з них можна застосовувати однакові правила синхронізації. Наприклад , пакети додатків Mac OS X дуже часто містять в собі символічні посилання на директорії системних бібліотек , і їх синхронізація в хмару була б небажана - особливо між різними версіями ОС . Але в той же час можливість синхронізувати додаткові директорії за допомогою символічних посилань - дуже приваблива можливість , упускати яку не хотілося.</p>
<p>Тому для синхронізації символічних посилань була введена особлива політика , завдяки якій ядро ​​може вибирати специфічний варіант синхронізації для кожної символічного посилання - залежно від розташування об'єкта , на який вона вказує.</p>
<p><strong>3</strong>. Отримання дерева хмарної файлової системи. Для вирішення проблеми синхронізації мало мати локальну файлову структуру і дайджести файлів - необхідно отримати поточний стан файлової системи в хмарі. Якби ядру синхронізації щоразу доводилося обходити дерево за допомогою методу PROPFIND , то кожен цикл синхронізації займав би невиправдано багато часу і створював би зайве навантаження на канал. Тому ПО Яндекс.Диск використовує спеціальний API , який дає можливість отримувати поточний стан дерева файлів у хмарі і зміни, що відбулися в ньому , починаючи з деякого відомого моменту, що визначається версією дерева.</p>
<p><strong>4</strong>. Отримання оповіщень про зміну хмарної файлової системи. Синхронізація файлів в реальному часі вимагає своєчасного одержання оповіщень про зміни , що сталися з файлами в хмарі. Можна було б використовувати періодичний опитування сервера клієнтами , але , оцінивши можливу кількість клієнтів , ми прийшли до висновку , що такий підхід виявиться слабо масштабованим і приведе до швидкої перевантаженні інфраструктури сервісу. Після недовгих пошуків ми зупинилися на протоколі XMPP . Одна з його реалізацій вже довгий час працює в Яндексі. Вона була розроблена командою , яка пізніше займалися створенням сервера WebDAV для проекту Яндекс.Диск , тому складнощів з інтеграцією цього протоколу не виникло.</p>
<p>Зараз пуш -сповіщення , оброблювані ядром синхронізації , включають в себе не тільки події, що відбулися безпосередньо з файлами або папками в хмарі Яндекс.Диск , але і різні сервісні повідомлення. Наприклад про видачу додаткового місця або діях інших користувачів у спільних папках . Додавання цих подій до наявного Протоколу не викликало великих труднощів завдяки розширюваності XMPP , що в черговий раз підтвердило правильність нашого вибору.</p>
<p><strong>5</strong>. Створення списку операцій синхронізації. Після того як у розпорядженні ядра синхронізації виявляються обидва дерева файлів - локальне та віддалене - можна приступати до самої процедури синхронізації. Для цього застосовується спеціальний алгоритм порівняння дерев , що приймає на вхід окрім двох згаданих дерев , ще й третє - останнє синхронізоване . В результаті роботи алгоритму виходить список операцій , які необхідно здійснити над локальними і віддаленими файлами і директорій для приведення дерев до загального вигляду .</p>
<p><strong>6</strong>. Обробка черги операцій синхронізації. Створення списку операцій для локального та віддаленого дерев відбувається незалежно. В результаті можуть з'явитися конфліктуючі операції . Наприклад , видалення в хмарі файлу , який був у ньому змінено і ще не синхронізований локально , або зміна файлу одночасно локально і в хмарі. Конфлікти модифікації / видалення завжди вирішуються ядром на користь модифікації , а конфлікти подвійний модифікації дозволяються перейменуванням однією з версій файлу. Таким чином ми можемо гарантувати збереження даних і даємо можливість після завершення синхронізації самому користувачеві вирішити, яке з змін більше йому підходить в кожному конкретному випадку.</p>
<p>Операції синхронізації повинні підкорятися строгому порядку , не можна передавати файл , поки не створена його батьківська директорія . Так само директорію не можна видаляти , поки всередині неї залишаються файли , які потрібно перемістити на нове місце. Алгоритм порівняння дерев вже створює операції в потрібному порядку , але при виникненні помилок він може порушитися . Для запобігання цій ситуації у кожній операції є список залежностей - набір операцій , які повинні завершитися до початку її виконання , і набір операцій , які не повинні початися , поки вона не буде виконана .</p>
<p>Крім залежностей на порядок виконання операцій впливає її пріоритет . Наприклад , операції передачі файлів виконуються в залежності від розмірів файлів - від маленьких до великих .</p>
<p>Всі ці завдання виконуються одночасно , накладаючи додаткові вимоги на якість синхронізації паралельних процесів і розподіл ресурсів всередині ядра синхронізації Яндекс.Диск. Якщо у вас ще немає Я.Диска , завести його можна <a href="http://disk.yandex.ru/">тут</a>, а встановити для Linux - тут: <a href="http://repo.yandex.ru/yandex-disk/">repo.yandex.ru/yandex-disk</a> .</p></div>
        <hr />
    </div>
		
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Попередня</a></li>

    <li class="active"><a href="http://localizator.github.io/tag/disk/.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Наступна</a></li>

</ul>
</div>
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                ДИВІТЬСЯ ТАКОЖ
                </li>
            
                <li><a href="http://localizator.github.io/archives.html">Архів тем</a>
                <li><a href="http://localizator.github.io/tags.html">Теги</a>
                <li><a href="http://feeds.feedburner.com/localizatornotes" rel="alternate">RSS</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                РОЗДІЛИ
                </li>
                
                <li><a href="http://localizator.github.io/category/apps/">apps</a></li>
                <li><a href="http://localizator.github.io/category/archlinux/">archlinux</a></li>
                <li><a href="http://localizator.github.io/category/howto/">howto</a></li>
                <li><a href="http://localizator.github.io/category/linux/">linux</a></li>
                <li><a href="http://localizator.github.io/category/news/">news</a></li>
                   
            </ul>
            </div>

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                ТЕГИ
                </li>
                
                <ul>
                <li class="tag-10"><a href="/tag/android/">android</a></li>
                <li class="tag-10"><a href="/tag/yandex/">yandex</a></li>
                <li class="tag-10"><a href="/tag/beta/">beta</a></li>
                <li class="tag-6"><a href="/tag/ubuntu/">ubuntu</a></li>
                <li class="tag-10"><a href="/tag/arch/">arch</a></li>
                <li class="tag-10"><a href="/tag/disk/">disk</a></li>
                <li class="tag-6"><a href="/tag/raringringtail/">raringringtail</a></li>
                <li class="tag-10"><a href="/tag/systemd/">systemd</a></li>
                <li class="tag-1"><a href="/tag/linux/">linux</a></li>
                <li class="tag-10"><a href="/tag/sales/">sales</a></li>
                <li class="tag-10"><a href="/tag/play/">play</a></li>
                <li class="tag-10"><a href="/tag/netctl/">netctl</a></li>
                <li class="tag-10"><a href="/tag/nano/">nano</a></li>
                <li class="tag-10"><a href="/tag/google/">google</a></li>
                <li class="tag-10"><a href="/tag/twitter/">twitter</a></li>
                <li class="tag-10"><a href="/tag/wayland/">wayland</a></li>
                <li class="tag-10"><a href="/tag/chromium/">chromium</a></li>
            </ul>                
            </ul>
            </div>

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                ПОСИЛАННЯ
                </li>
            
                <li><a href="http://www.archlinux.org/">Arch Linux</a></li>
                <li><a href="http://www.gentoo.org/">Gentoo</a></li>
                <li><a href="http://linux.org.ua/">LOU</a></li>
                <li><a href="http://www.fsf.org/">FSF</a></li>
                <li><a href="http://distrowatch.com/">DistroWatch</a></li>
                <li><a href="http://www.gnu.org/">GNU</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                СОЦІАЛЬНІ МЕРЕЖІ
                </li>
           
                <li><a href="https://plus.google.com/100150336880202859563">Google+</a></li>
                <li><a href="http://twitter.com/localizator">Twitter</a></li>
                <li><a href="http://github.com/localizator">GitHub</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer class="copyright">
</br>
<p>
<a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.uk"><img style="border: 0px none; padding-bottom: 3px; vertical-align: middle;" alt="Ліцензія Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a> «<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">localizator@notes</span>», <a xmlns:cc="http://creativecommons.org/ns#" href="http://localizator.github.io" property="cc:attributionName" rel="cc:attributionURL">localizator</a>, ліцензія <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.uk">CCA 3.0 Unported License</a>.
<span style="margin-left: 30px;"> Працює на <a href="http://docs.getpelican.com/">Pelican</a>. Шаблон від <a href="http://twitter.github.com/bootstrap/">Bootstrap</a>.</span>
</p>
</footer>

</div> <!-- /container -->
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<a href="http://localizator.github.io"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>
 
</body>
</html>