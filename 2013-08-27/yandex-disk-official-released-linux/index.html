<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Вийшов офіційний клієнт Яндекс.Диск для Linux</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Вийшов офіційний клієнт Яндекс.Диск для Linux"/>
            <meta property="og:url" content="http://localizator.github.io/2013-08-27/yandex-disk-official-released-linux/"/>
            <meta property="og:description" content="Яндекс.Диск - хмарний сервіс компанії Яндекс. Раніше з Linux працював тільки через WebDAV, для чого були придатні лише деякі файлові менеджери, або монтування за допомогою davfs2. Тепер випущений клієнт. Консольний, вихідні коди закриті - але настроювати зручніше, ніж davfs2, а синхронізація локальних файлів не вимагає скриптової обв'язки. Досить встановити програму ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://localizator.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://localizator.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://localizator.github.io/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://localizator.github.io/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

        <link href="http://localizator.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="localizator@notes ATOM Feed"/>

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-24257878-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://localizator.github.io" class="navbar-brand">localizator@notes</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/">Головна</a></li>
                    <li><a href="/category/news/">Новини</a></li>
                    <li><a href="/category/apps/">Програми</a></li>
                    <li><a href="/category/howto/">ЯКЦЕ</a></li>
                        <li><a href="http://localizator.github.io/about/">Про блог</a></li>
                        <li><a href="http://localizator.github.io/rom/">ROM</a></li>
                        <li><a href="http://localizator.github.io/services/">Послуги</a></li>
                        <li >
                            <a href="http://localizator.github.io/category/apps/">apps</a>
                        </li>
                        <li >
                            <a href="http://localizator.github.io/category/archlinux/">archlinux</a>
                        </li>
                        <li >
                            <a href="http://localizator.github.io/category/howto/">howto</a>
                        </li>
                        <li class="active">
                            <a href="http://localizator.github.io/category/linux/">linux</a>
                        </li>
                        <li >
                            <a href="http://localizator.github.io/category/news/">news</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://localizator.github.io/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://localizator.github.io/2013-08-27/yandex-disk-official-released-linux/"
                       rel="bookmark"
                       title="Permalink to Вийшов офіційний клієнт Яндекс.Диск для Linux">
                        Вийшов офіційний клієнт Яндекс.Диск для Linux
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>27 серпень 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="http://localizator.github.io/tag/yandex/">yandex</a>
        /
	<a href="http://localizator.github.io/tag/disk/">disk</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Яндекс.Диск - хмарний сервіс компанії Яндекс. Раніше з Linux працював тільки через WebDAV, для чого були придатні лише деякі файлові менеджери, або монтування за допомогою davfs2.</p>
<p>Тепер випущений клієнт. Консольний, вихідні коди закриті - але настроювати зручніше, ніж davfs2, а синхронізація локальних файлів не вимагає скриптової обв'язки. Досить встановити програму, налаштувати підключення, а потім вибрати каталоги, які підлягають або не підлягають синхронізації.
<!-- more -->
У нього є вся основна функціональність, яка є у клієнтів для OS X і Windows, і навіть більше (сімлінки!), і одна особливість - він консольний.</p>
<p><img alt="Яндекс.Диск" src="/images/2013/09/yandex_disk.png" />  </p>
<p>Нижче читайте про те, як він налаштовується, що конкретно вміє, і про те, як саме він влаштований і що в ньому було непросто зробити.</p>
<p><strong>Встановлення</strong></p>
<p>Встановити його можна <a href="http://repo.yandex.ru/yandex-disk/">тут</a>. Відразу після установки пакета в терміналі з'явиться команда <strong>yandex-disk</strong>, через яку в подальшому і йде робота з хмарою Яндекса. Після цього потрібно вручну запустити команду <strong>setup</strong>.</p>
<p>Майстер налаштування дозволяє в режимі діалогу вибрати папку для синхронізації, включити автозапуск при старті системи, налаштувати роботу через проксі-сервер (якщо звичайно ви ним користуєтеся) і авторизуватися в Яндекс.Диск. При налаштуванні вручну насамперед необхідно авторизуватися. Після цього в папці .config, розташованої в домашньому каталозі, буде створений конфіг, в якому можна буде налаштувати шлях до папки синхронізації (можна вказати в консолі вручну), прописати шлях до файлу токену, вказати папки, які будуть чи не будуть синхронізуватися, і прописати налаштування проксі-сервера.</p>
<p><strong>Команди</strong></p>
<p>Підготовча робота закінчена, залишилося запустити демон однієї з команд. Вони дозволять вам синхронізувати файли і папки і користуватися ними скрізь, де є інтернет .</p>
<ul>
<li><strong>sync</strong> - запустить демон, синхронізує все, що знаходиться в папці Диска, і зупинить демон.</li>
<li><strong>start</strong> - зробить те ж саме, але без зупинки демона після завершення синхронізації. При використанні start демон залишається запущений і всі зміни, що відбуваються в папці Диска , будуть синхронізуватися автоматично.</li>
<li>Ввівши в терміналі <strong>stop</strong>, можна в будь-який момент зупинити запущений демон, якщо він вам заважає.</li>
<li>Командою <strong>status</strong> можна дізнатися , в якому статусі знаходиться ядро ​​синхронізації.</li>
</ul>
<p>Працювати з папкою диска можна як з терміналу, так і з Nautilus'a.</p>
<p><strong>Що вміє</strong></p>
<p>Консольний клієнт дозволяє поділитися файлом або текою за допомогою команди <strong>publish</strong> (якщо файл знаходиться не в папці диска, перед публікацією він буде туди скопійований). Посилання буде доступна в терміналі, і будь-яка людина, перейшовши по ньому, зможе подивитися або зберегти собі опублікований вами файл або теку. Якщо випадково був опублікований не той файл, за допомогою команди <strong>unpublish</strong> можна закрити доступ до публічного об'єкту.</p>
<p>У Яндекс.Диск можлива вибіркова синхронізація. Команда <strong>exclude</strong> дозволить виключити папку з синхронізації: всі зміни, зроблені в ній після цього, не будуть відправлені в хмару.</p>
<p>Опція <strong>read-only</strong> дозволить міняти файли локально, без заливки їх в хмару. При виникненні конфліктів з локальними змінами, останні будуть збережені в перейменованих файлах, а зміни з хмари будуть синхронізовані. Опція <strong>overwrite</strong> буде перезаписувати локально змінені файли в режимі read-only .</p>
<p>Не можемо не похвалитися самим цікавим нововведенням в ядрі синхронізації - відтепер ми підтримуємо синхронізацію символічних посиланнь (symlink)! Якщо виникнуть труднощі і питання у використанні консольного клієнта команди man і help просто і доступно допоможуть у них розібратися.</p>
<p><strong>Як зроблено</strong></p>
<p>Щоб у майбутньому код можна було використовувати для реалізації клієнтів під різні ОС, було прийнято рішення писати його на C++. Специфічні для різних операційних систем шматки коду ми винесли в окремі функції чи класи, а під кожну платформу писали свою реалізацію. В якості основних кроссплатформенних бібліотек ми взяли Boost, OpenSSL і JsonCpp, а системою контролю версій став git. Клієнт під Linux збирався за допомогою autoconf. Код писався і налагоджувався у зв'язці KDevelop + консольний gdb  або в Qt Creator'е (залежно від уподобань розробника) .</p>
<p>Взаємодія з хмарою і синхронізація відбувається за допомогою бібліотеки ядра Яндекс.Диск , яку використовують десктопні клієнти сервісу.</p>
<p><strong>Як працює</strong></p>
<p>Консольний клієнт складається з двох частин: демона і клієнта. Спілкуються вони за допомогою текстових пакетів містять json - повідомлення, що посилаються через сокети (на Linux і Mac OS X використовуються unix - domain сокети). Асинхронна робота реалізована за допомогою бібліотеки boost::asio. Синхронізація доступу до даних реалізується через boost::asio::io_service::strand, що дозволяє не думати про проблему одночасного доступу до даних декількох потоків, а також виключає появу deadlock-ів.</p>
<p>Для локалізації ми використовуємо бібліотеку boost::locale. Текст всередині клієнта закодований в utf 8 і за необхідності перетворюється в специфічному для кожної операційної системи коді. Моніторинг файлової системи для Linux використовує inotify, чудово вписуються в асинхронну роботу boost::asio.</p>
<p><strong>Як влаштована синхронізація</strong></p>
<p>Синхронізація - серце Яндекс.Диск, його ключова можливість. Завдання синхронізації файлового дерева з хмарою ділиться на кілька незалежних частин.</p>
<p><strong>1.</strong> Моніторинг файлової системи. Ядро синхронізації Яндекс.Диск проектувалося і створювалося як переносима абстракція, здатна виконувати поставлені завдання на всіх підтримуваних платформах. Але така проблема, як моніторинг файлової системи не реалізується ні стандартної бібліотекою C++, ні навіть такими монстрами як boost. Більше того, навіть використовуючи «рідне» API операційної системи, ми отримуємо набір подій, специфічний для кожної платформи.</p>
<p>Для моніторингу файлової системи був спроектований інтерфейс «спостерігача» , здатного стежити за подіями в певній директорії і повертає список подій, що відбулися в ній. Причому для кожної підтримуваної платформи набір цих подій відрізняється. Наприклад, Mac OS X здатна повідомити тільки про факт якогось зміни в одній з дочірніх директоріях без деталізації. А ось Windows і Linux повертають повний набір, включаючи створення, видалення, модифікацію і переміщення об'єктів. Хоча практика показувала, що подіям на платформі Windows довіряти не варто і самим надійним варіантом залишається лістинг директорії після отримання оповіщення.</p>
<p><strong>2.</strong> Індексація локальних файлів і директорій. Для контролю цілісності та реалізації дельта -оновлення файлів ядро синхронізації Яндекс.Диск використовує дайджести - набори контрольних сум файлу і окремих його частин. Для всього файлу ми розраховуємо стійкий хеш SHA-256 і набір менш стійких сум для окремих блоків. Кожен файл, що знаходиться в папці Яндекс.Диск і не потрапляє до списку винятків, повинен бути проіндексований. Але обчислення хеша SHA-256 досить дорога операція, а розрахунок хешей при кожному запуску ПО був б великою витратою ресурсів. Тому після того, як завершується індексація файлу , ядро синхронізації зберігає отриманий дайджест в «банці» - спеціальному сховищі, що знаходиться у службовій директорії Яндекс.Диск. Для пошуку дайджестів в сховище використовується унікальний ідентифікатор файлу - inode (розмір і час останньої зміни) . На жаль, подібний підхід не позбавлений недоліків. Наприклад, багато файлів - криптоконтейнера зберігають час останньої модифікації незмінним навіть після запису .</p>
<p>Напевно, крім тонкощів роботи з символічними посиланнями , нічого в лістингу директорій не представляє особливого інтересу. Для успішного завершення синхронізації ядро повинне виявляти і виключати з синхронізації циклічні гілки .</p>
<p>Взагалі , символічні посилання - це справжня «головна біль» для ядра синхронізації. Вони можуть вказувати у довільні місця файлової системи , і ні до всіх з них можна застосовувати однакові правила синхронізації. Наприклад , пакети додатків Mac OS X дуже часто містять в собі символічні посилання на директорії системних бібліотек , і їх синхронізація в хмару була б небажана - особливо між різними версіями ОС . Але в той же час можливість синхронізувати додаткові директорії за допомогою символічних посилань - дуже приваблива можливість , упускати яку не хотілося.</p>
<p>Тому для синхронізації символічних посилань була введена особлива політика , завдяки якій ядро ​​може вибирати специфічний варіант синхронізації для кожної символічного посилання - залежно від розташування об'єкта , на який вона вказує.</p>
<p><strong>3</strong>. Отримання дерева хмарної файлової системи. Для вирішення проблеми синхронізації мало мати локальну файлову структуру і дайджести файлів - необхідно отримати поточний стан файлової системи в хмарі. Якби ядру синхронізації щоразу доводилося обходити дерево за допомогою методу PROPFIND , то кожен цикл синхронізації займав би невиправдано багато часу і створював би зайве навантаження на канал. Тому ПО Яндекс.Диск використовує спеціальний API , який дає можливість отримувати поточний стан дерева файлів у хмарі і зміни, що відбулися в ньому , починаючи з деякого відомого моменту, що визначається версією дерева.</p>
<p><strong>4</strong>. Отримання оповіщень про зміну хмарної файлової системи. Синхронізація файлів в реальному часі вимагає своєчасного одержання оповіщень про зміни , що сталися з файлами в хмарі. Можна було б використовувати періодичний опитування сервера клієнтами , але , оцінивши можливу кількість клієнтів , ми прийшли до висновку , що такий підхід виявиться слабо масштабованим і приведе до швидкої перевантаженні інфраструктури сервісу. Після недовгих пошуків ми зупинилися на протоколі XMPP . Одна з його реалізацій вже довгий час працює в Яндексі. Вона була розроблена командою , яка пізніше займалися створенням сервера WebDAV для проекту Яндекс.Диск , тому складнощів з інтеграцією цього протоколу не виникло.</p>
<p>Зараз пуш -сповіщення , оброблювані ядром синхронізації , включають в себе не тільки події, що відбулися безпосередньо з файлами або папками в хмарі Яндекс.Диск , але і різні сервісні повідомлення. Наприклад про видачу додаткового місця або діях інших користувачів у спільних папках . Додавання цих подій до наявного Протоколу не викликало великих труднощів завдяки розширюваності XMPP , що в черговий раз підтвердило правильність нашого вибору.</p>
<p><strong>5</strong>. Створення списку операцій синхронізації. Після того як у розпорядженні ядра синхронізації виявляються обидва дерева файлів - локальне та віддалене - можна приступати до самої процедури синхронізації. Для цього застосовується спеціальний алгоритм порівняння дерев , що приймає на вхід окрім двох згаданих дерев , ще й третє - останнє синхронізоване . В результаті роботи алгоритму виходить список операцій , які необхідно здійснити над локальними і віддаленими файлами і директорій для приведення дерев до загального вигляду .</p>
<p><strong>6</strong>. Обробка черги операцій синхронізації. Створення списку операцій для локального та віддаленого дерев відбувається незалежно. В результаті можуть з'явитися конфліктуючі операції . Наприклад , видалення в хмарі файлу , який був у ньому змінено і ще не синхронізований локально , або зміна файлу одночасно локально і в хмарі. Конфлікти модифікації / видалення завжди вирішуються ядром на користь модифікації , а конфлікти подвійний модифікації дозволяються перейменуванням однією з версій файлу. Таким чином ми можемо гарантувати збереження даних і даємо можливість після завершення синхронізації самому користувачеві вирішити, яке з змін більше йому підходить в кожному конкретному випадку.</p>
<p>Операції синхронізації повинні підкорятися строгому порядку , не можна передавати файл , поки не створена його батьківська директорія . Так само директорію не можна видаляти , поки всередині неї залишаються файли , які потрібно перемістити на нове місце. Алгоритм порівняння дерев вже створює операції в потрібному порядку , але при виникненні помилок він може порушитися . Для запобігання цій ситуації у кожній операції є список залежностей - набір операцій , які повинні завершитися до початку її виконання , і набір операцій , які не повинні початися , поки вона не буде виконана .</p>
<p>Крім залежностей на порядок виконання операцій впливає її пріоритет . Наприклад , операції передачі файлів виконуються в залежності від розмірів файлів - від маленьких до великих .</p>
<p>Всі ці завдання виконуються одночасно , накладаючи додаткові вимоги на якість синхронізації паралельних процесів і розподіл ресурсів всередині ядра синхронізації Яндекс.Диск. Якщо у вас ще немає Я.Диска , завести його можна <a href="http://disk.yandex.ru/">тут</a>, а встановити для Linux - тут: <a href="http://repo.yandex.ru/yandex-disk/">repo.yandex.ru/yandex-disk</a> .</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'localizatorblog'; // required: replace example with your forum shortname
            var disqus_identifier = 'yandex-disk-official-released-linux';
            var disqus_url = 'http://localizator.github.io/2013-08-27/yandex-disk-official-released-linux/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="https://plus.google.com/100150336880202859563"><i
                            class="icon-Google+-sign icon-large"></i>Google+
                    </a></li>
                    <li class="list-group-item"><a href="http://twitter.com/localizator"><i
                            class="icon-Twitter-sign icon-large"></i>Twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/localizator"><i
                            class="icon-GitHub-sign icon-large"></i>GitHub
                    </a></li>



            <li class="list-group-item"><a href="http://localizator.github.io/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item tag-1">
                    <a href="http://localizator.github.io/tag/linux/">
                        linux
                    </a>
                </li>
                <li class="list-group-item tag-6">
                    <a href="http://localizator.github.io/tag/raringringtail/">
                        raringringtail
                    </a>
                </li>
                <li class="list-group-item tag-6">
                    <a href="http://localizator.github.io/tag/ubuntu/">
                        ubuntu
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/systemd/">
                        systemd
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/arch/">
                        arch
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/chromium/">
                        chromium
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/wayland/">
                        wayland
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/play/">
                        play
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/beta/">
                        beta
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/nano/">
                        nano
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/netctl/">
                        netctl
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/google/">
                        google
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/twitter/">
                        twitter
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/sales/">
                        sales
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/android/">
                        android
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/yandex/">
                        yandex
                    </a>
                </li>
                <li class="list-group-item tag-10">
                    <a href="http://localizator.github.io/tag/disk/">
                        disk
                    </a>
                </li>
        </ul>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://localizator.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://localizator.github.io/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'localizatorblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>